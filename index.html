<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bach - Partita No.2 BWV 1004 - Chord Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8e8e8;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.5em;
            color: #ffd700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            font-size: 1.2em;
            color: #c0c0c0;
            font-style: italic;
        }

        .movement-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .movement-btn {
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            border-radius: 10px;
            color: #ffd700;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Georgia', serif;
        }

        .movement-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .movement-btn.active {
            background: #ffd700;
            color: #1a1a2e;
            font-weight: bold;
        }

        .movement-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .movement-info h2 {
            color: #ffd700;
            margin-bottom: 5px;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            flex-wrap: wrap;
        }

        .playback-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-btn {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Georgia', serif;
            font-weight: bold;
        }

        .play-btn {
            background: #4CAF50;
            color: white;
        }

        .play-btn:hover {
            background: #45a049;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .pause-btn {
            background: #FF9800;
            color: white;
        }

        .pause-btn:hover {
            background: #F57C00;
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }

        .stop-btn {
            background: #f44336;
            color: white;
        }

        .stop-btn:hover {
            background: #da190b;
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .loop-btn {
            background: rgba(156, 39, 176, 0.3);
            color: white;
            border: 2px solid #9C27B0;
        }

        .loop-btn.active {
            background: #9C27B0;
        }

        .loop-btn:hover {
            background: rgba(156, 39, 176, 0.5);
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.4);
        }

        .metronome-indicator {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid #ffd700;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #ffd700;
        }

        .metronome-indicator.beat {
            background: #ffd700;
            color: #1a1a2e;
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        .tempo-control, .volume-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider {
            width: 150px;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffd700;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffd700;
            cursor: pointer;
        }

        .control-label {
            min-width: 120px;
            color: #ffd700;
            font-size: 0.9em;
        }

        .audio-settings {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .audio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .audio-option label {
            color: #c0c0c0;
            font-size: 0.9em;
        }

        .audio-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .practice-mode {
            background: rgba(33, 150, 243, 0.1);
            border: 2px solid #2196F3;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .practice-mode h3 {
            color: #2196F3;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .practice-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .practice-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .practice-input label {
            font-size: 0.85em;
            color: #2196F3;
        }

        .practice-input input {
            width: 80px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #2196F3;
            border-radius: 5px;
            color: white;
            font-size: 1em;
        }

        .practice-btn {
            padding: 12px 25px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .practice-btn:hover {
            background: #1976D2;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        .practice-btn.active {
            background: #FF5722;
        }

        .practice-progress {
            flex: 1;
            min-width: 200px;
            color: #2196F3;
            font-weight: bold;
        }

        .section-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .section-nav-btn {
            padding: 10px 20px;
            background: rgba(33, 150, 243, 0.2);
            border: 2px solid #2196F3;
            border-radius: 8px;
            color: #2196F3;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Georgia', serif;
            font-weight: bold;
        }

        .section-nav-btn:hover {
            background: rgba(33, 150, 243, 0.3);
            transform: translateY(-2px);
        }

        .section-nav-btn.active {
            background: #2196F3;
            color: white;
        }

        .chord-display {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            color: #ffd700;
            font-size: 1.3em;
            margin-bottom: 10px;
            padding: 5px 10px;
            background: rgba(255, 215, 0, 0.1);
            border-left: 4px solid #ffd700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-loop-btn {
            font-size: 0.8em;
            padding: 5px 15px;
            background: rgba(156, 39, 176, 0.3);
            color: white;
            border: 1px solid #9C27B0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .section-loop-btn:hover,
        .section-loop-btn.active {
            background: #9C27B0;
        }

        .chord-line {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        .chord-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .chord {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            min-width: 60px;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .chord:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .chord.playing {
            background: #ffd700;
            color: #1a1a2e;
            font-weight: bold;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        .roman-numeral {
            font-size: 0.75em;
            color: #9C27B0;
            font-weight: bold;
            font-family: 'Georgia', serif;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .controls {
                gap: 10px;
            }

            .slider {
                width: 100px;
            }

            .chord-line {
                gap: 5px;
            }

            .chord {
                padding: 6px 8px;
                font-size: 0.9em;
                min-width: 50px;
            }

            .control-label {
                min-width: 100px;
                font-size: 0.8em;
            }

            .metronome-indicator {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Partita No. 2 BWV 1004</h1>
            <p class="subtitle">Johann Sebastian Bach - Re menor</p>
        </header>

        <div class="movement-selector">
            <button class="movement-btn active" data-movement="gigue">
                Gigue<br><small>(12/8)</small>
            </button>
            <button class="movement-btn" data-movement="sarabande">
                Sarabande<br><small>(3/4)</small>
            </button>
            <button class="movement-btn" data-movement="courante">
                Courante<br><small>(3/4)</small>
            </button>
            <button class="movement-btn" data-movement="allemanda">
                Allemanda<br><small>(4/4)</small>
            </button>
        </div>

        <div class="controls">
            <div class="playback-controls">
                <button class="control-btn play-btn" id="playBtn">‚ñ∂ Play</button>
                <button class="control-btn pause-btn" id="pauseBtn" style="display: none;">‚è∏ Pausa</button>
                <button class="control-btn stop-btn" id="stopBtn">‚ñ† Stop</button>
                <button class="control-btn loop-btn" id="loopBtn">üîÅ Loop</button>
            </div>

            <div id="metronomeIndicator" class="metronome-indicator">‚ô©</div>

            <div class="tempo-control">
                <label class="control-label">Tempo: <span id="tempoValue">120</span> BPM</label>
                <input type="range" class="slider" id="tempoSlider" min="40" max="200" value="120">
            </div>

            <div class="volume-control">
                <label class="control-label">Volumen: <span id="volumeValue">70</span>%</label>
                <input type="range" class="slider" id="volumeSlider" min="0" max="100" value="70">
            </div>
        </div>

        <div class="controls audio-settings">
            <div class="audio-option">
                <input type="checkbox" id="arpeggioToggle" checked>
                <label for="arpeggioToggle">Arpegios</label>
            </div>
            <div class="audio-option">
                <input type="checkbox" id="reverbToggle" checked>
                <label for="reverbToggle">Reverb</label>
            </div>
            <div class="audio-option">
                <input type="checkbox" id="metronomeToggle">
                <label for="metronomeToggle">Metr√≥nomo</label>
            </div>
            <div class="audio-option">
                <label for="instrumentSelect">Instrumento:</label>
                <select id="instrumentSelect" style="padding: 5px; background: rgba(255,255,255,0.1); color: white; border: 1px solid #ffd700; border-radius: 5px;">
                    <option value="piano">Piano</option>
                    <option value="strings" selected>Cuerdas</option>
                    <option value="organ">√ìrgano</option>
                </select>
            </div>
        </div>

        <div class="practice-mode">
            <h3>üéØ Modo Pr√°ctica</h3>
            <div class="practice-controls">
                <div class="practice-input">
                    <label>Tempo Inicial</label>
                    <input type="number" id="practiceStart" value="60" min="40" max="200">
                </div>
                <div class="practice-input">
                    <label>Tempo Final</label>
                    <input type="number" id="practiceEnd" value="120" min="40" max="200">
                </div>
                <div class="practice-input">
                    <label>Incremento</label>
                    <input type="number" id="practiceIncrement" value="5" min="1" max="20">
                </div>
                <button class="practice-btn" id="practiceModeBtn">Iniciar Pr√°ctica</button>
                <div class="practice-progress" id="practiceProgress"></div>
            </div>
        </div>

        <div class="section-nav" id="sectionNav">
            <!-- Section navigation buttons will be rendered here -->
        </div>

        <div class="movement-info">
            <h2 id="currentMovement">Gigue</h2>
            <p id="currentTimeSignature">12/8 - Re menor</p>
        </div>

        <div class="chord-display" id="chordDisplay">
            <!-- Chords will be rendered here -->
        </div>
    </div>

    <script>
        // Roman numeral analysis for each movement
        const romanNumerals = {
            gigue: {
                A: [
                    ["i", "i", "V7", "V7", "i", "i", "iv", "V7"],
                    ["i", "i", "VII", "III", "VI", "V7", "i", "V7"]
                ],
                B: [
                    ["V", "V", "V/V", "V/V", "V", "V", "vi", "ii"],
                    ["V/V", "V", "V7/vi", "vi", "ii", "V/V", "V", "V7"]
                ],
                C: [
                    ["i", "i", "V7", "V7", "i", "iv", "VII/III", "III"],
                    ["VI", "VI", "V7", "V7", "i", "iv", "V7", "i"]
                ],
                D: [
                    ["i", "VII", "III", "VI", "iv", "V7", "i", "i"],
                    ["i", "V7/v", "v", "i", "iv", "V7", "i", "i"]
                ]
            },
            sarabande: {
                A: [
                    ["i", "V7", "i", "iv", "V7", "i", "i", "i"],
                    ["III", "VII", "i", "V7", "i", "i", "i", "i"]
                ],
                B: [
                    ["III", "VII", "i", "V7", "i", "VI", "V7", "V7"],
                    ["i", "iv", "VII/III", "III", "VI", "V7", "i", "i"]
                ],
                C: [
                    ["I", "V", "vi", "V7/vi", "vi", "ii", "V7", "V7"],
                    ["I", "V", "vi", "vi", "ii", "V7", "I", "I"]
                ],
                D: [
                    ["i", "V7", "i", "iv", "V7", "i", "i", "viio7"],
                    ["i", "iv", "VII/III", "III", "VI", "V7", "i", "i"]
                ]
            },
            courante: {
                A: [
                    ["i", "V7", "i", "iv", "VII", "III", "VI", "V7"],
                    ["i", "V7", "i", "V7/v", "v", "V7/v", "v", "V7"]
                ],
                B: [
                    ["i", "V7", "i", "iv", "V7", "i", "iv", "VII/III"],
                    ["III", "VII", "III", "VI", "iv", "V7", "i", "i"]
                ],
                C: [
                    ["i", "VII/III", "III", "VI", "V7", "i", "iv", "V7"],
                    ["i", "V7", "i", "iv", "VII/III", "III", "VI", "V7"]
                ],
                D: [
                    ["i", "iv", "VII", "III", "VI", "V7/v", "v", "v"],
                    ["i", "V7", "i", "VI", "iv", "V7", "i", "i"]
                ]
            },
            allemanda: {
                A: [
                    ["i", "V7", "i", "V7", "i", "i7", "iv", "V7"],
                    ["i", "VII", "III", "VI", "iv", "VII/III", "III", "V7"]
                ],
                B: [
                    ["i", "V7", "i", "iv", "V", "V7/V", "V", "V"],
                    ["vi", "V7/V", "V", "V7/vi", "vi", "ii", "V7/V", "V7"]
                ],
                C: [
                    ["i", "V7", "i", "VI", "iv", "VII/III", "III", "V7"],
                    ["VI", "V7", "i", "V7/v", "v", "III", "iv", "V7"]
                ],
                D: [
                    ["i", "V7", "i", "iv", "VII/III", "III", "VI", "V7"],
                    ["i", "iv", "VII/III", "III", "iv", "V7", "i", "i"]
                ]
            }
        };

        // Chord progressions data
        const movements = {
            gigue: {
                name: "Gigue",
                timeSignature: "12/8",
                beatsPerMeasure: 4,
                sections: {
                    A: [
                        ["D-", "D-", "A7", "A7", "D-", "D-", "G-", "A7"],
                        ["D-", "D-", "C", "F", "Bb", "A7", "D-", "A7"]
                    ],
                    B: [
                        ["A", "A", "E7", "E7", "A", "A", "F#-", "B-"],
                        ["E7", "A", "C#7", "F#-", "B-", "E7", "A", "A7"]
                    ],
                    C: [
                        ["D-", "D-", "A7", "A7", "D-", "G-", "C7", "F"],
                        ["Bb", "Bb", "A7", "A7", "D-", "G-", "A7", "D-"]
                    ],
                    D: [
                        ["D-", "C", "F", "Bb", "G-", "A7", "D-", "D-"],
                        ["D-", "E7", "A-", "D-", "G-", "A7", "D-", "D-"]
                    ]
                }
            },
            sarabande: {
                name: "Sarabande",
                timeSignature: "3/4",
                beatsPerMeasure: 3,
                sections: {
                    A: [
                        ["D-", "A7/C#", "D-/F", "G-/Bb", "A7", "D-", "D-", "D-"],
                        ["F", "C", "D-", "A7", "D-", "D-", "D-", "D-"]
                    ],
                    B: [
                        ["F", "C/E", "D-", "A7/C#", "D-/F", "Bb", "A7", "A7"],
                        ["D-", "G-", "C7", "F", "Bb", "A7", "D-", "D-"]
                    ],
                    C: [
                        ["D", "A/C#", "B-", "F#7/A#", "B-/D", "E-", "A7", "A7"],
                        ["D", "A", "F#-", "B-", "E-", "A7", "D", "D"]
                    ],
                    D: [
                        ["D-", "A7/C#", "D-/F", "G-/Bb", "A7", "D-", "D-", "C#o7"],
                        ["D-/F", "G-", "C7", "F", "Bb", "A7", "D-", "D-"]
                    ]
                }
            },
            courante: {
                name: "Courante",
                timeSignature: "3/4",
                beatsPerMeasure: 3,
                sections: {
                    A: [
                        ["D-", "A7", "D-", "G-", "C", "F", "Bb", "A7"],
                        ["D-", "A7", "D-", "E7", "A", "E7", "A", "A7"]
                    ],
                    B: [
                        ["D-", "A7", "D-/F", "G-", "A7", "D-", "G-", "C7"],
                        ["F", "C", "F", "Bb", "G-", "A7", "D-", "D-"]
                    ],
                    C: [
                        ["D-", "C7", "F", "Bb", "A7", "D-", "G-", "A7"],
                        ["D-", "A7/C#", "D-/F", "G-", "C7", "F", "Bb", "A7"]
                    ],
                    D: [
                        ["D-", "G-", "C", "F", "Bb", "E7", "A-", "A"],
                        ["D-", "A7", "D-", "Bb", "G-", "A7", "D-", "D-"]
                    ]
                }
            },
            allemanda: {
                name: "Allemanda",
                timeSignature: "4/4",
                beatsPerMeasure: 4,
                sections: {
                    A: [
                        ["D-", "A7", "D-", "A7/C#", "D-", "D-7/F", "G-", "A7"],
                        ["D-", "C", "F", "Bb/F", "G-", "C7", "F", "A7"]
                    ],
                    B: [
                        ["D-", "A7/C#", "D-/F", "G-", "A/E", "E7", "A", "A/C#"],
                        ["B-/D", "E7", "A", "C#7/A", "F#-", "B-", "E7", "A7"]
                    ],
                    C: [
                        ["D-", "A7", "D-", "Bb", "G-", "C7", "F", "A7/C#"],
                        ["Bb", "A7", "D-", "E7", "A-", "F", "G-", "A7"]
                    ],
                    D: [
                        ["D-", "A7/C#", "D-/F", "G-", "C7", "F", "Bb", "A7"],
                        ["D-", "G-", "C7", "F", "G-", "A7", "D-", "D-"]
                    ]
                }
            }
        };

        // Chord to notes mapping
        const chordNotes = {
            "D-": ["D3", "F3", "A3", "D4"],
            "A7": ["A2", "E3", "G3", "C#4"],
            "G-": ["G3", "Bb3", "D4"],
            "C": ["C3", "E3", "G3", "C4"],
            "F": ["F3", "A3", "C4"],
            "Bb": ["Bb2", "D3", "F3", "Bb3"],
            "A": ["A2", "C#3", "E3", "A3"],
            "E7": ["E2", "G#3", "B3", "D4"],
            "F#-": ["F#3", "A3", "C#4"],
            "B-": ["B2", "D3", "F#3"],
            "C#7": ["C#3", "F3", "G#3", "B3"],
            "C7": ["C3", "E3", "G3", "Bb3"],
            "A7/C#": ["C#3", "E3", "G3", "A3"],
            "D-/F": ["F3", "A3", "D4"],
            "G-/Bb": ["Bb2", "D3", "G3"],
            "C/E": ["E3", "G3", "C4"],
            "A/C#": ["C#3", "E3", "A3"],
            "F#7/A#": ["A#2", "C#3", "E3", "F#3"],
            "B-/D": ["D3", "F#3", "B3"],
            "E-": ["E3", "G3", "B3"],
            "C#o7": ["C#3", "E3", "G3", "Bb3"],
            "D": ["D3", "F#3", "A3", "D4"],
            "A/E": ["E3", "A3", "C#4"],
            "C#7/A": ["A2", "C#3", "F3", "G#3"],
            "A-": ["A2", "C3", "E3"],
            "D-7/F": ["F3", "A3", "C4"],
            "Bb/F": ["F3", "Bb3", "D4"]
        };

        // Audio setup
        let synth, reverb, metronomeClick;
        let currentMovement = 'gigue';
        let isPlaying = false;
        let isPaused = false;
        let currentChordIndex = 0;
        let tempo = 120;
        let volume = 70;
        let playbackInterval;
        let metronomeInterval;
        let loopEnabled = false;
        let loopSection = null;
        let allChords = [];
        let arpeggioEnabled = true;
        let reverbEnabled = true;
        let currentInstrument = 'strings';
        let metronomeEnabled = false;
        let currentBeat = 0;

        // Practice mode variables
        let practiceModeActive = false;
        let practiceStartTempo = 60;
        let practiceEndTempo = 120;
        let practiceIncrement = 5;
        let practiceCurrentTempo = 60;

        // Initialize Tone.js
        async function initAudio() {
            await Tone.start();

            // Create reverb
            reverb = new Tone.Reverb({
                decay: 2.5,
                wet: 0.3
            }).toDestination();

            // Create metronome click
            metronomeClick = new Tone.MembraneSynth({
                pitchDecay: 0.008,
                octaves: 2,
                envelope: {
                    attack: 0.0006,
                    decay: 0.5,
                    sustain: 0
                },
                volume: -10
            }).toDestination();

            updateSynth();
        }

        function updateSynth() {
            if (synth) {
                synth.disconnect();
                synth.dispose();
            }

            const baseVolume = (volume / 100) * 10 - 15;

            const synthParams = {
                piano: {
                    envelope: {
                        attack: 0.005,
                        decay: 0.3,
                        sustain: 0.2,
                        release: 1.5
                    },
                    volume: baseVolume
                },
                strings: {
                    envelope: {
                        attack: 0.1,
                        decay: 0.3,
                        sustain: 0.7,
                        release: 2.0
                    },
                    volume: baseVolume
                },
                organ: {
                    envelope: {
                        attack: 0.02,
                        decay: 0.1,
                        sustain: 0.9,
                        release: 0.5
                    },
                    volume: baseVolume
                }
            };

            synth = new Tone.PolySynth(Tone.Synth, synthParams[currentInstrument]);

            if (reverbEnabled) {
                synth.connect(reverb);
            } else {
                synth.toDestination();
            }
        }

        // Play metronome click
        function playMetronomeClick(isDownbeat) {
            if (!metronomeEnabled || !metronomeClick) return;

            const pitch = isDownbeat ? 'C5' : 'C4';
            metronomeClick.triggerAttackRelease(pitch, '8n');

            // Visual feedback
            const indicator = document.getElementById('metronomeIndicator');
            indicator.classList.add('beat');
            indicator.textContent = currentBeat + 1;
            setTimeout(() => {
                indicator.classList.remove('beat');
                indicator.textContent = '‚ô©';
            }, 100);
        }

        // Start metronome
        function startMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
            }

            const movement = movements[currentMovement];
            const beatDuration = (60 / tempo) * 1000; // milliseconds per beat

            currentBeat = 0;

            metronomeInterval = setInterval(() => {
                playMetronomeClick(currentBeat === 0);
                currentBeat = (currentBeat + 1) % movement.beatsPerMeasure;
            }, beatDuration);
        }

        // Stop metronome
        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
            }
            currentBeat = 0;
            const indicator = document.getElementById('metronomeIndicator');
            indicator.classList.remove('beat');
            indicator.textContent = '‚ô©';
        }

        // Play a chord with arpeggio option
        function playChord(chordSymbol, measureDuration) {
            if (!synth) return;

            const notes = chordNotes[chordSymbol] || chordNotes["D-"];

            if (arpeggioEnabled) {
                notes.forEach((note, index) => {
                    const delay = index * 0.05;
                    synth.triggerAttackRelease(note, measureDuration * 0.9, Tone.now() + delay);
                });
            } else {
                synth.triggerAttackRelease(notes, measureDuration * 0.9);
            }
        }

        // Render section navigation
        function renderSectionNav() {
            const nav = document.getElementById('sectionNav');
            const movement = movements[currentMovement];

            let html = '<button class="section-nav-btn active" data-section="all">Todas</button>';
            for (const section of Object.keys(movement.sections)) {
                html += `<button class="section-nav-btn" data-section="${section}">Secci√≥n ${section}</button>`;
            }

            nav.innerHTML = html;

            document.querySelectorAll('.section-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.section-nav-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const section = btn.dataset.section;
                    loopSection = section === 'all' ? null : section;
                });
            });
        }

        // Render chord display
        function renderChords() {
            const display = document.getElementById('chordDisplay');
            const movement = movements[currentMovement];
            const romansForMovement = romanNumerals[currentMovement];

            let html = '';
            for (const [section, lines] of Object.entries(movement.sections)) {
                html += `<div class="section" data-section="${section}">`;
                html += `<div class="section-title">
                    Secci√≥n ${section}
                    <button class="section-loop-btn" data-loop-section="${section}">üîÅ Loop ${section}</button>
                </div>`;

                lines.forEach((line, lineIndex) => {
                    html += `<div class="chord-line">`;
                    line.forEach((chord, chordIndex) => {
                        const roman = romansForMovement[section][lineIndex][chordIndex];
                        html += `<div class="chord-container">
                            <div class="chord" data-section="${section}" data-line="${lineIndex}" data-chord="${chordIndex}">${chord}</div>
                            <div class="roman-numeral">${roman}</div>
                        </div>`;
                    });
                    html += `</div>`;
                });

                html += `</div>`;
            }

            display.innerHTML = html;

            // Add click listeners to chords
            document.querySelectorAll('.chord').forEach(chord => {
                chord.addEventListener('click', async () => {
                    if (!synth) await initAudio();
                    const chordSymbol = chord.textContent;
                    const movement = movements[currentMovement];
                    const beatDuration = 60 / tempo;
                    const measureDuration = beatDuration * movement.beatsPerMeasure;
                    playChord(chordSymbol, measureDuration);

                    chord.classList.add('playing');
                    setTimeout(() => chord.classList.remove('playing'), 500);
                });
            });

            // Add click listeners to section loop buttons
            document.querySelectorAll('.section-loop-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const section = btn.dataset.loopSection;

                    document.querySelectorAll('.section-loop-btn').forEach(b => b.classList.remove('active'));

                    if (loopSection === section) {
                        loopSection = null;
                    } else {
                        loopSection = section;
                        btn.classList.add('active');
                    }

                    document.querySelectorAll('.section-nav-btn').forEach(b => b.classList.remove('active'));
                    if (loopSection) {
                        document.querySelector(`[data-section="${loopSection}"]`).classList.add('active');
                    } else {
                        document.querySelector('[data-section="all"]').classList.add('active');
                    }
                });
            });
        }

        // Highlight current chord
        function highlightChord(section, line, chord) {
            document.querySelectorAll('.chord').forEach(el => el.classList.remove('playing'));
            const selector = `[data-section="${section}"][data-line="${line}"][data-chord="${chord}"]`;
            const element = document.querySelector(selector);
            if (element) {
                element.classList.add('playing');
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Build chord list for playback
        function buildChordList() {
            const movement = movements[currentMovement];
            allChords = [];

            if (loopSection) {
                const lines = movement.sections[loopSection];
                lines.forEach((line, lineIndex) => {
                    line.forEach((chord, chordIndex) => {
                        allChords.push({ chord, section: loopSection, line: lineIndex, chordIndex });
                    });
                });
            } else {
                for (const [section, lines] of Object.entries(movement.sections)) {
                    lines.forEach((line, lineIndex) => {
                        line.forEach((chord, chordIndex) => {
                            allChords.push({ chord, section, line: lineIndex, chordIndex });
                        });
                    });
                }
            }
        }

        // Play movement
        function playMovement() {
            if (isPlaying && !isPaused) return;

            if (!isPaused) {
                buildChordList();
                currentChordIndex = 0;
            }

            isPlaying = true;
            isPaused = false;

            updatePlaybackButtons();

            if (metronomeEnabled) {
                startMetronome();
            }

            const movement = movements[currentMovement];
            const beatDuration = 60 / tempo;
            const measureDuration = beatDuration * movement.beatsPerMeasure;
            const measureDurationMs = measureDuration * 1000;

            playbackInterval = setInterval(() => {
                if (currentChordIndex >= allChords.length) {
                    if (loopEnabled || practiceModeActive) {
                        currentChordIndex = 0;

                        // Practice mode: increment tempo
                        if (practiceModeActive) {
                            practiceCurrentTempo += practiceIncrement;
                            if (practiceCurrentTempo > practiceEndTempo) {
                                practiceCurrentTempo = practiceEndTempo;
                                practiceModeActive = false;
                                document.getElementById('practiceModeBtn').classList.remove('active');
                                document.getElementById('practiceModeBtn').textContent = 'Iniciar Pr√°ctica';
                                updatePracticeProgress('Pr√°ctica completada! üéâ');
                            } else {
                                tempo = practiceCurrentTempo;
                                document.getElementById('tempoValue').textContent = tempo;
                                document.getElementById('tempoSlider').value = tempo;
                                updatePracticeProgress();

                                // Restart with new tempo
                                stopPlayback();
                                playMovement();
                                return;
                            }
                        }
                    } else {
                        stopPlayback();
                        return;
                    }
                }

                const current = allChords[currentChordIndex];
                playChord(current.chord, measureDuration);
                highlightChord(current.section, current.line, current.chordIndex);

                currentChordIndex++;
            }, measureDurationMs);
        }

        // Pause playback
        function pausePlayback() {
            isPaused = true;
            isPlaying = false;
            if (playbackInterval) {
                clearInterval(playbackInterval);
            }
            stopMetronome();
            updatePlaybackButtons();
        }

        // Stop playback
        function stopPlayback() {
            isPlaying = false;
            isPaused = false;
            if (playbackInterval) {
                clearInterval(playbackInterval);
            }
            stopMetronome();
            document.querySelectorAll('.chord').forEach(el => el.classList.remove('playing'));
            currentChordIndex = 0;
            updatePlaybackButtons();
        }

        // Update playback button visibility
        function updatePlaybackButtons() {
            const playBtn = document.getElementById('playBtn');
            const pauseBtn = document.getElementById('pauseBtn');

            if (isPlaying) {
                playBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-block';
            } else {
                playBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'none';
            }
        }

        // Update practice progress
        function updatePracticeProgress(message = null) {
            const progress = document.getElementById('practiceProgress');
            if (message) {
                progress.textContent = message;
            } else {
                progress.textContent = `Tempo actual: ${practiceCurrentTempo} BPM ‚Üí Objetivo: ${practiceEndTempo} BPM`;
            }
        }

        // Toggle practice mode
        function togglePracticeMode() {
            if (practiceModeActive) {
                practiceModeActive = false;
                document.getElementById('practiceModeBtn').classList.remove('active');
                document.getElementById('practiceModeBtn').textContent = 'Iniciar Pr√°ctica';
                document.getElementById('practiceProgress').textContent = '';
            } else {
                practiceStartTempo = parseInt(document.getElementById('practiceStart').value);
                practiceEndTempo = parseInt(document.getElementById('practiceEnd').value);
                practiceIncrement = parseInt(document.getElementById('practiceIncrement').value);

                if (practiceStartTempo >= practiceEndTempo) {
                    alert('El tempo inicial debe ser menor que el tempo final');
                    return;
                }

                practiceModeActive = true;
                practiceCurrentTempo = practiceStartTempo;
                tempo = practiceCurrentTempo;
                document.getElementById('tempoValue').textContent = tempo;
                document.getElementById('tempoSlider').value = tempo;

                document.getElementById('practiceModeBtn').classList.add('active');
                document.getElementById('practiceModeBtn').textContent = 'Detener Pr√°ctica';
                updatePracticeProgress();

                // Auto-start playback
                if (!isPlaying) {
                    playMovement();
                }
            }
        }

        // Event listeners
        document.getElementById('playBtn').addEventListener('click', async () => {
            if (!synth) await initAudio();
            playMovement();
        });

        document.getElementById('pauseBtn').addEventListener('click', pausePlayback);

        document.getElementById('stopBtn').addEventListener('click', stopPlayback);

        document.getElementById('loopBtn').addEventListener('click', () => {
            loopEnabled = !loopEnabled;
            document.getElementById('loopBtn').classList.toggle('active');
        });

        document.getElementById('tempoSlider').addEventListener('input', (e) => {
            tempo = parseInt(e.target.value);
            document.getElementById('tempoValue').textContent = tempo;

            if (isPlaying) {
                stopPlayback();
                playMovement();
            }
        });

        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            volume = parseInt(e.target.value);
            document.getElementById('volumeValue').textContent = volume;
            if (synth) {
                updateSynth();
            }
        });

        document.getElementById('arpeggioToggle').addEventListener('change', (e) => {
            arpeggioEnabled = e.target.checked;
        });

        document.getElementById('reverbToggle').addEventListener('change', (e) => {
            reverbEnabled = e.target.checked;
            if (synth) {
                updateSynth();
            }
        });

        document.getElementById('metronomeToggle').addEventListener('change', (e) => {
            metronomeEnabled = e.target.checked;
            if (metronomeEnabled && isPlaying) {
                startMetronome();
            } else {
                stopMetronome();
            }
        });

        document.getElementById('instrumentSelect').addEventListener('change', (e) => {
            currentInstrument = e.target.value;
            if (synth) {
                updateSynth();
            }
        });

        document.getElementById('practiceModeBtn').addEventListener('click', togglePracticeMode);

        document.querySelectorAll('.movement-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                stopPlayback();

                document.querySelectorAll('.movement-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                currentMovement = btn.dataset.movement;
                const movement = movements[currentMovement];

                document.getElementById('currentMovement').textContent = movement.name;
                document.getElementById('currentTimeSignature').textContent = `${movement.timeSignature} - Re menor`;

                renderSectionNav();
                renderChords();
                loopSection = null;
            });
        });

        // Initialize
        renderSectionNav();
        renderChords();
    </script>
</body>
</html>
